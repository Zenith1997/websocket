"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _ws = _interopRequireDefault(require("ws"));

var _axios = _interopRequireDefault(require("axios"));

var _crypto = _interopRequireDefault(require("crypto"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const createRequestConfig = function createRequestConfig({
  key,
  secret,
  payload
}) {
  const encodedPayload = Buffer.from(JSON.stringify(payload)).toString(`base64`);

  const signature = _crypto.default.createHmac(`sha384`, secret).update(encodedPayload).digest(`hex`);

  return {
    headers: {
      'X-GEMINI-APIKEY': key,
      'X-GEMINI-PAYLOAD': encodedPayload,
      'X-GEMINI-SIGNATURE': signature
    }
  };
};

const makeParams = function makeParams(options = {}) {
  let params;
  params = Object.keys(options).reduce((acc, crtKey) => {
    let prs;

    if (Array.isArray(options[crtKey])) {
      prs = options[crtKey].reduce((a, crtP) => {
        return `${a}&${crtKey}=${crtP === true && 'true' || crtP === false && 'false' || crtP}`;
      }, acc);
      return prs;
    } else {
      return `${acc}&${crtKey}=${options[crtKey] === true && 'true' || options[crtKey] === false && 'false' || options[crtKey]}`;
    }
  }, "");

  if (params !== '') {
    params = `?${params.substring(1)}`;
  }

  return params;
};

class Gemini {
  constructor({
    key,
    secret,
    sandbox = false
  } = {
    sandbox: false
  }) {
    this.key = key;
    this.secret = secret;
    const subdomain = sandbox ? `api.sandbox` : `api`;
    this.baseUrl = `https://${subdomain}.gemini.com`;
  }

  async requestPublic(endpoint, params = {}) {
    let res = await _axios.default.get(`${this.baseUrl}/v1${endpoint}`, {
      params
    });
    return res.data;
  }

  async requestPrivate(endpoint, params = {}) {
    if (!this.key || !this.secret) {
      throw new Error(`API key and secret key required to use authenticated methods`);
    }

    const requestPath = `/v1${endpoint}`;
    const requestUrl = `${this.baseUrl}${requestPath}`;
    const payload = {
      nonce: Date.now(),
      request: requestPath,
      ...params
    };
    const config = createRequestConfig({
      payload,
      key: this.key,
      secret: this.secret
    });
    let res = await _axios.default.post(requestUrl, {}, config);
    return res.data;
  } // Public API


  getAllSymbols() {
    return this.requestPublic(`/symbols`);
  }

  getTicker(symbol) {
    return this.requestPublic(`/pubticker/${symbol}`);
  }

  getOrderBook(symbol, params = {}) {
    return this.requestPublic(`/book/${symbol}`, params);
  }

  getTradeHistory(symbol, params = {}) {
    return this.requestPublic(`/trades/${symbol}`, params);
  }

  getCurrentAuction(symbol) {
    return this.requestPublic(`/auction/${symbol}`);
  }

  getAuctionHistory(symbol, params = {}) {
    return this.requestPublic(`/auction/${symbol}/history`, params);
  } // Order Placement API


  newOrder(params = {}) {
    return this.requestPrivate(`/order/new`, {
      type: `exchange limit`,
      ...params
    });
  }

  cancelOrder({
    order_id
  } = {}) {
    return this.requestPrivate(`/order/cancel`, {
      order_id
    });
  }

  cancelAllSessionOrders() {
    return this.requestPrivate(`/order/cancel/session`);
  }

  cancelAllActiveOrders() {
    return this.requestPrivate(`/order/cancel/all`);
  } // Order Status API


  getMyOrderStatus({
    order_id
  } = {}) {
    return this.requestPrivate(`/order/status`, {
      order_id
    });
  }

  getMyActiveOrders() {
    return this.requestPrivate(`/orders`);
  }

  getMyPastTrades(params = {}) {
    return this.requestPrivate(`/mytrades`, params);
  }

  getMyTradeVolume() {
    return this.requestPrivate(`/tradevolume`);
  } // Fund Management API


  getMyAvailableBalances() {
    return this.requestPrivate(`/balances`);
  }

  newAddress(currency) {
    return this.requestPrivate(`/deposit/${currency}/newAddress`);
  } // WebSocket


  newWebSocketOrderEvents(options = {}) {
    const requestPath = `/v1/order/events`;
    const params = makeParams(options);
    return new _ws.default(`${this.baseUrl}${requestPath}${params}`, createRequestConfig({
      key: this.key,
      secret: this.secret,
      payload: {
        nonce: Date.now(),
        request: requestPath
      }
    }));
  }

  newWebSocketMarketData(symbol, options = {}) {
    const requestPath = `/v1/marketdata`;
    const params = makeParams(options);
    return new _ws.default(`${this.baseUrl}${requestPath}/${symbol}${params}`);
  }

}

exports.default = Gemini;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJjcmVhdGVSZXF1ZXN0Q29uZmlnIiwia2V5Iiwic2VjcmV0IiwicGF5bG9hZCIsImVuY29kZWRQYXlsb2FkIiwiQnVmZmVyIiwiZnJvbSIsIkpTT04iLCJzdHJpbmdpZnkiLCJ0b1N0cmluZyIsInNpZ25hdHVyZSIsImNyeXB0byIsImNyZWF0ZUhtYWMiLCJ1cGRhdGUiLCJkaWdlc3QiLCJoZWFkZXJzIiwibWFrZVBhcmFtcyIsIm9wdGlvbnMiLCJwYXJhbXMiLCJPYmplY3QiLCJrZXlzIiwicmVkdWNlIiwiYWNjIiwiY3J0S2V5IiwicHJzIiwiQXJyYXkiLCJpc0FycmF5IiwiYSIsImNydFAiLCJzdWJzdHJpbmciLCJHZW1pbmkiLCJjb25zdHJ1Y3RvciIsInNhbmRib3giLCJzdWJkb21haW4iLCJiYXNlVXJsIiwicmVxdWVzdFB1YmxpYyIsImVuZHBvaW50IiwicmVzIiwiYXhpb3MiLCJnZXQiLCJkYXRhIiwicmVxdWVzdFByaXZhdGUiLCJFcnJvciIsInJlcXVlc3RQYXRoIiwicmVxdWVzdFVybCIsIm5vbmNlIiwiRGF0ZSIsIm5vdyIsInJlcXVlc3QiLCJjb25maWciLCJwb3N0IiwiZ2V0QWxsU3ltYm9scyIsImdldFRpY2tlciIsInN5bWJvbCIsImdldE9yZGVyQm9vayIsImdldFRyYWRlSGlzdG9yeSIsImdldEN1cnJlbnRBdWN0aW9uIiwiZ2V0QXVjdGlvbkhpc3RvcnkiLCJuZXdPcmRlciIsInR5cGUiLCJjYW5jZWxPcmRlciIsIm9yZGVyX2lkIiwiY2FuY2VsQWxsU2Vzc2lvbk9yZGVycyIsImNhbmNlbEFsbEFjdGl2ZU9yZGVycyIsImdldE15T3JkZXJTdGF0dXMiLCJnZXRNeUFjdGl2ZU9yZGVycyIsImdldE15UGFzdFRyYWRlcyIsImdldE15VHJhZGVWb2x1bWUiLCJnZXRNeUF2YWlsYWJsZUJhbGFuY2VzIiwibmV3QWRkcmVzcyIsImN1cnJlbmN5IiwibmV3V2ViU29ja2V0T3JkZXJFdmVu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O0FBQ1AwQyxRQUFBQSxLQUFLLEVBQUVDLElBQUksQ0FBQ0MsR0FBTCxFQURBO0FBRVBDLFFBQUFBLE9BQU8sRUFBRUw7QUFGRjtBQUh3RSxLQUFELENBQTNFLENBQVA7QUFRRDs7QUFFRDhCLEVBQUFBLHNCQUFzQixDQUFDcEIsTUFBRCxFQUFTcEMsT0FBTyxHQUFHLEVBQW5CLEVBQXVCO0FBQzNDLFVBQU0wQixXQUFXLEdBQUksZ0JBQXJCO0FBQ0EsVUFBTXpCLE1BQU0sR0FBR0YsVUFBVSxDQUFDQyxPQUFELENBQXpCO0FBRUEsV0FBTyxJQUFJdUQsV0FBSixDQUFlLEdBQUUsS0FBS3RDLE9BQVEsR0FBRVMsV0FBWSxJQUFHVSxNQUFPLEdBQUVuQyxNQUFPLEVBQS9ELENBQVA7QUFDRDs7QUFuSXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cydcclxuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJ1xyXG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XHJcblxyXG5jb25zdCBjcmVhdGVSZXF1ZXN0Q29uZmlnID0gZnVuY3Rpb24gY3JlYXRlUmVxdWVzdENvbmZpZyAoeyBrZXksIHNlY3JldCwgcGF5bG9hZCB9KSB7XHJcbiAgY29uc3QgZW5jb2RlZFBheWxvYWQgPSAoQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkocGF5bG9hZCkpKVxyXG4gICAgLnRvU3RyaW5nKGBiYXNlNjRgKVxyXG5cclxuICBjb25zdCBzaWduYXR1cmUgPSBjcnlwdG9cclxuICAgIC5jcmVhdGVIbWFjKGBzaGEzODRgLCBzZWNyZXQpXHJcbiAgICAudXBkYXRlKGVuY29kZWRQYXlsb2FkKVxyXG4gICAgLmRpZ2VzdChgaGV4YClcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGhlYWRlcnM6IHtcclxuICAgICAgJ1gtR0VNSU5JLUFQSUtFWSc6IGtleSxcclxuICAgICAgJ1gtR0VNSU5JLVBBWUxPQUQnOiBlbmNvZGVkUGF5bG9hZCxcclxuICAgICAgJ1gtR0VNSU5JLVNJR05BVFVSRSc6IHNpZ25hdHVyZSxcclxuICAgIH0sXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBtYWtlUGFyYW1zID0gZnVuY3Rpb24gbWFrZVBhcmFtcyhvcHRpb25zID0ge30pIHtcclxuICBsZXQgcGFyYW1zXHJcbiAgcGFyYW1zID0gT2JqZWN0LmtleXMob3B0aW9ucykucmVkdWNlKChhY2MsIGNydEtleSkgPT4ge1xyXG4gICAgbGV0IHByc1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkob3B0aW9uc1tjcnRLZXldKSkge1xyXG4gICAgICBwcnMgPSBvcHRpb25zW2NydEtleV0ucmVkdWNlKChhLCBjcnRQKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGAke2F9JiR7Y3J0S2V5fT0ke2NydFAgPT09IHRydWUgJiYgJ3RydWUnIHx8IGNydFAgPT09IGZhbHNlICYmICdmYWxzZScgfHwgY3J0UH1gXHJcbiAgICAgIH0sIGFjYylcclxuICAgICAgcmV0dXJuIHByc1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIGAke2FjY30mJHtjcnRLZXl9PSR7b3B0aW9uc1tjcnRLZXldID09PSB0cnVlICYmICd0cnVlJyB8fCBvcHRpb25zW2NydEtleV0gPT09IGZhbHNlICYmICdmYWxzZScgfHwgb3B0aW9uc1tjcnRLZXldfWBcclxuICAgIH1cclxuICB9LCBcIlwiKVxyXG5cclxuICBpZiAocGFyYW1zICE9PSAnJykge1xyXG4gICAgcGFyYW1zID0gYD8ke3BhcmFtcy5zdWJzdHJpbmcoMSl9YFxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHBhcmFtc1xyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHZW1pbmkge1xyXG4gIGNvbnN0cnVjdG9yKHsga2V5LCBzZWNyZXQsIHNhbmRib3ggPSBmYWxzZSB9ID0geyBzYW5kYm94OiBmYWxzZSB9KSB7XHJcbiAgICB0aGlzLmtleSA9IGtleTtcclxuICAgIHRoaXMuc2VjcmV0ID0gc2VjcmV0O1xyXG4gICAgY29uc3Qgc3ViZG9tYWluID0gc2FuZGJveCA/IGBhcGkuc2FuZGJveGAgOiBgYXBpYDtcclxuICAgIHRoaXMuYmFzZVVybCA9IGBodHRwczovLyR7c3ViZG9tYWlufS5nZW1pbmkuY29tYDtcclxuICB9XHJcblxyXG4gIGFzeW5jIHJlcXVlc3RQdWJsaWMoZW5kcG9pbnQsIHBhcmFtcyA9IHt9KSB7XHJcbiAgICBsZXQgcmVzICA9IGF3YWl0IGF4aW9zLmdldChgJHt0aGlzLmJhc2VVcmx9L3YxJHtlbmRwb2ludH1gLCB7IHBhcmFtcyB9KVxyXG4gICAgcmV0dXJuIHJlcy5kYXRhXHJcbiAgfVxyXG5cclxuICBhc3luYyByZXF1ZXN0UHJpdmF0ZShlbmRwb2ludCwgcGFyYW1zID0ge30pIHtcclxuICAgIGlmICghdGhpcy5rZXkgfHwgIXRoaXMuc2VjcmV0KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICBgQVBJIGtleSBhbmQgc2VjcmV0IGtleSByZXF1aXJlZCB0byB1c2UgYXV0aGVudGljYXRlZCBtZXRob2RzYCxcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCByZXF1ZXN0UGF0aCA9IGAvdjEke2VuZHBvaW50fWA7XHJcbiAgICBjb25zdCByZXF1ZXN0VXJsID0gYCR7dGhpcy5iYXNlVXJsfSR7cmVxdWVzdFBhdGh9YDtcclxuICAgIGNvbnN0IHBheWxvYWQgPSB7XHJcbiAgICAgIG5vbmNlOiBEYXRlLm5vdygpLFxyXG4gICAgICByZXF1ZXN0OiByZXF1ZXN0UGF0aCxcclxuICAgICAgLi4ucGFyYW1zLFxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBjb25maWcgPSBjcmVhdGVSZXF1ZXN0Q29uZmlnKHtcclxuICAgICAgcGF5bG9hZCxcclxuICAgICAga2V5OiB0aGlzLmtleSxcclxuICAgICAgc2VjcmV0OiB0aGlzLnNlY3JldCxcclxuICAgIH0pO1xyXG5cclxuICAgIGxldCByZXMgPSBhd2FpdCBheGlvcy5wb3N0KHJlcXVlc3RVcmwsIHt9LCBjb25maWcpXHJcbiAgICByZXR1cm4gcmVzLmRhdGFcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYyBBUElcclxuICBnZXRBbGxTeW1ib2xzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdFB1YmxpYyhgL3N5bWJvbHNgKVxyXG4gIH1cclxuXHJcbiAgZ2V0VGlja2VyKHN5bWJvbCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdFB1YmxpYyhgL3B1YnRpY2tlci8ke3N5bWJvbH1gKVxyXG4gIH1cclxuXHJcbiAgZ2V0T3JkZXJCb29rKHN5bWJvbCwgcGFyYW1zID0ge30pIHtcclxuICAgIHJldHVybiB0aGlzLnJlcXVlc3RQdWJsaWMoYC9ib29rLyR7c3ltYm9sfWAsIHBhcmFtcylcclxuICB9XHJcblxyXG4gIGdldFRyYWRlSGlzdG9yeShzeW1ib2wsIHBhcmFtcyA9IHt9KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UHVibGljKGAvdHJhZGVzLyR7c3ltYm9sfWAsIHBhcmFtcylcclxuICB9XHJcblxyXG4gIGdldEN1cnJlbnRBdWN0aW9uKHN5bWJvbCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdFB1YmxpYyhgL2F1Y3Rpb24vJHtzeW1ib2x9YClcclxuICB9XHJcblxyXG4gIGdldEF1Y3Rpb25IaXN0b3J5KHN5bWJvbCwgcGFyYW1zID0ge30pIHtcclxuICAgIHJldHVybiB0aGlzLnJlcXVlc3RQdWJsaWMoYC9hdWN0aW9uLyR7c3ltYm9sfS9oaXN0b3J5YCwgcGFyYW1zKVxyXG4gIH1cclxuXHJcbiAgLy8gT3JkZXIgUGxhY2VtZW50IEFQSVxyXG4gIG5ld09yZGVyKHBhcmFtcyA9IHt9KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UHJpdmF0ZShgL29yZGVyL25ld2AsIHtcclxuICAgICAgdHlwZTogYGV4Y2hhbmdlIGxpbWl0YCxcclxuICAgICAgLi4ucGFyYW1zLFxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGNhbmNlbE9yZGVyKHsgb3JkZXJfaWQgfSA9IHt9KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UHJpdmF0ZShgL29yZGVyL2NhbmNlbGAsIHsgb3JkZXJfaWQgfSlcclxuICB9XHJcblxyXG4gIGNhbmNlbEFsbFNlc3Npb25PcmRlcnMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UHJpdmF0ZShgL29yZGVyL2NhbmNlbC9zZXNzaW9uYClcclxuICB9XHJcblxyXG5cclxuICBjYW5jZWxBbGxBY3RpdmVPcmRlcnMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UHJpdmF0ZShgL29yZGVyL2NhbmNlbC9hbGxgKVxyXG4gIH1cclxuXHJcbiAgLy8gT3JkZXIgU3RhdHVzIEFQSVxyXG4gIGdldE15T3JkZXJTdGF0dXMoeyBvcmRlcl9pZCB9ID0ge30pIHtcclxuICAgIHJldHVybiB0aGlzLnJlcXVlc3RQcml2YXRlKGAvb3JkZXIvc3RhdHVzYCwgeyBvcmRlcl9pZCB9KVxyXG4gIH1cclxuXHJcbiAgZ2V0TXlBY3RpdmVPcmRlcnMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UHJpdmF0ZShgL29yZGVyc2ApXHJcbiAgfVxyXG5cclxuXHJcbiAgZ2V0TXlQYXN0VHJhZGVzIChwYXJhbXMgPSB7fSkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdFByaXZhdGUoYC9teXRyYWRlc2AsIHBhcmFtcylcclxuICB9XHJcblxyXG4gIGdldE15VHJhZGVWb2x1bWUoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UHJpdmF0ZShgL3RyYWRldm9sdW1lYClcclxuICB9XHJcblxyXG4gIC8vIEZ1bmQgTWFuYWdlbWVudCBBUElcclxuICBnZXRNeUF2YWlsYWJsZUJhbGFuY2VzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdFByaXZhdGUoYC9iYWxhbmNlc2ApXHJcbiAgfVxyXG5cclxuICBuZXdBZGRyZXNzKGN1cnJlbmN5KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0UHJpdmF0ZShgL2RlcG9zaXQvJHtjdXJyZW5jeX0vbmV3QWRkcmVzc2ApXHJcbiAgfVxyXG5cclxuICAvLyBXZWJTb2NrZXRcclxuICBuZXdXZWJTb2NrZXRPcmRlckV2ZW50cyhvcHRpb25zID0ge30pIHtcclxuICAgIGNvbnN0IHJlcXVlc3RQYXRoID0gYC92MS9vcmRlci9ldmVudHNgXHJcbiAgICBjb25zdCBwYXJhbXMgPSBtYWtlUGFyYW1zKG9wdGlvbnMpXHJcblxyXG4gICAgcmV0dXJuIG5ldyBXZWJTb2NrZXQoYCR7dGhpcy5iYXNlVXJsfSR7cmVxdWVzdFBhdGh9JHtwYXJhbXN9YCwgY3JlYXRlUmVxdWVzdENvbmZpZyh7XHJcbiAgICAgIGtleTogdGhpcy5rZXksXHJcbiAgICAgIHNlY3JldDogdGhpcy5zZWNyZXQsXHJcbiAgICAgIHBheWxvYWQ6IHtcclxuICAgICAgICBub25jZTogRGF0ZS5ub3coKSxcclxuICAgICAgICByZXF1ZXN0OiByZXF1ZXN0UGF0aCxcclxuICAgICAgfSxcclxuICAgIH0pKVxyXG4gIH1cclxuXHJcbiAgbmV3V2ViU29ja2V0TWFya2V0RGF0YShzeW1ib2wsIG9wdGlvbnMgPSB7fSkge1xyXG4gICAgY29uc3QgcmVxdWVzdFBhdGggPSBgL3YxL21hcmtldGRhdGFgXHJcbiAgICBjb25zdCBwYXJhbXMgPSBtYWtlUGFyYW1zKG9wdGlvbnMpXHJcblxyXG4gICAgcmV0dXJuIG5ldyBXZWJTb2NrZXQoYCR7dGhpcy5iYXNlVXJsfSR7cmVxdWVzdFBhdGh9LyR7c3ltYm9sfSR7cGFyYW1zfWApXHJcbiAgfVxyXG59XHJcbiJdfQ==